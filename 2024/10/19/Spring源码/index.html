

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/mimi-blog/img/fluid.png">
  <link rel="icon" href="/mimi-blog/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Mimiboss">
  <meta name="keywords" content="">
  
    <meta name="description" content="BeanDefinition 包装了一个类的 Mate 数据信息，这里的 Mate 数据指的是在外观来看 Bean 涉及到了那些信息，例如 XML 中声明一个 Bean 的 id、class、scope 等。 &lt;font style&#x3D;&quot;color:#DF2A3F;&quot;&gt;接口抽象类组织软件框架、底层实现类展示功能细节&lt;&#x2F;font&gt;。  12345&lt;be">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring源码">
<meta property="og:url" content="https://xiaomaoboss.github.io/mimi-blog/2024/10/19/Spring%E6%BA%90%E7%A0%81/index.html">
<meta property="og:site_name" content="Mimiboss">
<meta property="og:description" content="BeanDefinition 包装了一个类的 Mate 数据信息，这里的 Mate 数据指的是在外观来看 Bean 涉及到了那些信息，例如 XML 中声明一个 Bean 的 id、class、scope 等。 &lt;font style&#x3D;&quot;color:#DF2A3F;&quot;&gt;接口抽象类组织软件框架、底层实现类展示功能细节&lt;&#x2F;font&gt;。  12345&lt;be">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xiaomaoboss.github.io/mimi-blog/image/image-20241020095407700.png">
<meta property="og:image" content="https://xiaomaoboss.github.io/mimi-blog/image/1728903724451-a09b0f3f-4ca3-474a-a371-ea8068190180.png">
<meta property="og:image" content="https://xiaomaoboss.github.io/mimi-blog/image/1728974018400-30f5eeeb-d7c0-4a39-9b49-f60d4e9a28d9.png">
<meta property="og:image" content="https://xiaomaoboss.github.io/mimi-blog/image/1728977669199-d7713f12-deb9-4984-8a16-22b2d7f7b6ee.png">
<meta property="og:image" content="https://xiaomaoboss.github.io/mimi-blog/image/1729171572346-9ebb74ce-fc66-4f48-bcaf-83413aabd00d.png">
<meta property="og:image" content="https://xiaomaoboss.github.io/mimi-blog/image/1729301274943-09d72d7a-402f-4865-b919-cfc322845080.png">
<meta property="og:image" content="https://xiaomaoboss.github.io/mimi-blog/image/1729318401537-1b939e0f-10b8-4bd9-91ee-cae9a28010cf.png">
<meta property="og:image" content="https://xiaomaoboss.github.io/mimi-blog/image/1729317823228-1799276b-3fad-43b9-ba29-816c236e13b0.png">
<meta property="article:published_time" content="2024-10-19T07:47:37.000Z">
<meta property="article:modified_time" content="2024-10-20T04:34:52.310Z">
<meta property="article:author" content="Mimiboss">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="知识库">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://xiaomaoboss.github.io/mimi-blog/image/image-20241020095407700.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Spring源码 - Mimiboss</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/mimi-blog/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/mimi-blog/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/mimi-blog/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"xiaomaoboss.github.io","root":"/mimi-blog/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/mimi-blog/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/mimi-blog/js/utils.js" ></script>
  <script  src="/mimi-blog/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  



  
<!-- 引入 Particles.js -->
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/mimi-blog/">
      <strong>Mimi个人博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/mimi-blog/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/mimi-blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/mimi-blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/mimi-blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/mimi-blog/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  <head>
	<script>
	var _hmt = _hmt || [];
	(function() {
	  	var hm = document.createElement("script");
	  	hm.src = "https://hm.baidu.com/hm.js?65f5994ae5e35c170c7caf330fab3051";
	  	var s = document.getElementsByTagName("script")[0]; 
	  	s.parentNode.insertBefore(hm, s);
	})();
</script>

</head>


<div id="banner" class="banner" parallax=true
     style="background: url('/mimi-blog/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Spring源码"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-10-19 15:47" pubdate>
          2024年10月19日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          26k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          214 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Spring源码</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：1 天前
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="BeanDefinition"><a href="#BeanDefinition" class="headerlink" title="BeanDefinition"></a>BeanDefinition</h1><ol>
<li>包装了一个类的 Mate 数据信息，这里的 Mate 数据指的是在外观来看 Bean 涉及到了那些信息，例如 XML 中声明一个 Bean 的 id、class、scope 等。</li>
<li><code>&lt;font style=&quot;color:#DF2A3F;&quot;&gt;接口抽象类组织软件框架、底层实现类展示功能细节&lt;/font&gt;</code>。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;bean id=<span class="hljs-string">&quot;userEntity&quot;</span> class=<span class="hljs-string">&quot;com.mimiboss.entity.UserPojo&quot;</span> scope=<span class="hljs-string">&quot;prototype&quot;</span>&gt;<br>    &lt;property name=<span class="hljs-string">&quot;date&quot;</span> ref=<span class="hljs-string">&quot;date&quot;</span>/&gt;<br>    &lt;property name=<span class="hljs-string">&quot;sessionId&quot;</span> value=<span class="hljs-string">&quot;sessionId&quot;</span>/&gt;<br>    &lt;property name=<span class="hljs-string">&quot;username&quot;</span> value=<span class="hljs-string">&quot;username&quot;</span>/&gt;<br>&lt;/bean&gt;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>其中收集Bean的元数据为一下几种：</li>
</ol>
<p><img src="/mimi-blog/image/image-20241020095407700.png" srcset="/mimi-blog/img/loading.gif" lazyload alt="image-20241020095407700"></p>
<h2 id="常用体系结构"><a href="#常用体系结构" class="headerlink" title="常用体系结构"></a>常用体系结构</h2><p><img src="/mimi-blog/image/1728903724451-a09b0f3f-4ca3-474a-a371-ea8068190180.png" srcset="/mimi-blog/img/loading.gif" lazyload></p>
<h1 id="ClassPathBeanDefinitionScanner"><a href="#ClassPathBeanDefinitionScanner" class="headerlink" title="ClassPathBeanDefinitionScanner"></a>ClassPathBeanDefinitionScanner</h1><ol>
<li>指定全限定包，进行扫描。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">BeanDefinitionRegistry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleBeanDefinitionRegistry</span>();<br>        <span class="hljs-comment">// 扫描某个包下的被注解的类   放入到注册器中  实质就是一个线程安全的Map</span><br>        <span class="hljs-type">ClassPathBeanDefinitionScanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathBeanDefinitionScanner</span>(registry);<br>        scanner.scan(<span class="hljs-string">&quot;springx&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;scan -&gt; &quot;</span> + Arrays.toString(registry.getBeanDefinitionNames()));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Scanner-源码"><a href="#Scanner-源码" class="headerlink" title="Scanner 源码"></a>Scanner 源码</h2><ol>
<li>scan (String …args)方法。</li>
<li>Spring 中 do 打头的方法一定是核心（doScan、doDispatcher…）。</li>
<li><code>BeanDefinitionHolder</code>其中 Holder 表示持有者，就是重新封装了一下 BeanDifinition，添加了 beanName 和 aliases 别名。</li>
<li>将 BeanDefinition 封装为 BeanDefinitionHolder。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">scan</span><span class="hljs-params">(String... basePackages)</span> &#123;<br>    <span class="hljs-comment">// 获取注册器中被注册的BeanDefinition数量</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">beanCountAtScanStart</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.registry.getBeanDefinitionCount();<br>    <span class="hljs-built_in">this</span>.doScan(basePackages);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.includeAnnotationConfig) &#123;<br>        AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="hljs-built_in">this</span>.registry);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.registry.getBeanDefinitionCount() - beanCountAtScanStart;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title function_">doScan</span><span class="hljs-params">(String... basePackages)</span> &#123;<br>    Assert.notEmpty(basePackages, <span class="hljs-string">&quot;At least one base package must be specified&quot;</span>);<br>    <span class="hljs-comment">// 待返回Set集合</span><br>    Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>();<br>    <span class="hljs-comment">// 加载包&#123;&#x27;com.mimiboss.springx&#x27;, &#x27;xxx.xxxx.xxx&#x27;&#125;</span><br>    String[] var3 = basePackages;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> basePackages.length;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var5 &lt; var4; ++var5) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">basePackage</span> <span class="hljs-operator">=</span> var3[var5];<br>        <span class="hljs-comment">// 找到被注解的类，为候选BeanDefinition</span><br>        Set&lt;BeanDefinition&gt; candidates = <span class="hljs-built_in">this</span>.findCandidateComponents(basePackage);<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">var8</span> <span class="hljs-operator">=</span> candidates.iterator();<br><br>        <span class="hljs-keyword">while</span>(var8.hasNext()) &#123;<br>            <span class="hljs-comment">// 拿到BeanDefinition   （MybatisConfiguration）</span><br>            <span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">candidate</span> <span class="hljs-operator">=</span> (BeanDefinition)var8.next();<br>            <span class="hljs-comment">// 设置作用域   （作用域元数据）  @Scope 注解</span><br>            <span class="hljs-type">ScopeMetadata</span> <span class="hljs-variable">scopeMetadata</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.scopeMetadataResolver.resolveScopeMetadata(candidate);<br>            candidate.setScope(scopeMetadata.getScopeName());<br>            <span class="hljs-comment">// 从Generator中拿到beanName</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.beanNameGenerator.generateBeanName(candidate, <span class="hljs-built_in">this</span>.registry);<br>            <span class="hljs-comment">// 分类处理</span><br>            <span class="hljs-keyword">if</span> (candidate <span class="hljs-keyword">instanceof</span> AbstractBeanDefinition abstractBeanDefinition) &#123;<br>                <span class="hljs-built_in">this</span>.postProcessBeanDefinition(abstractBeanDefinition, beanName);<br>            &#125;<br><br>            <span class="hljs-comment">// 被注解的AnnotatedBeanDefinition</span><br>            <span class="hljs-keyword">if</span> (candidate <span class="hljs-keyword">instanceof</span> AnnotatedBeanDefinition annotatedBeanDefinition) &#123;<br>                AnnotationConfigUtils.processCommonDefinitionAnnotations(annotatedBeanDefinition);<br>            &#125;<br><br>            <span class="hljs-comment">// 检查是否是候选的BeanDefinition</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.checkCandidate(beanName, candidate)) &#123;<br>                <span class="hljs-comment">// 封装为 BeanDefinitionHolder</span><br>                <span class="hljs-type">BeanDefinitionHolder</span> <span class="hljs-variable">definitionHolder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionHolder</span>(candidate, beanName);<br>                definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="hljs-built_in">this</span>.registry);<br>                beanDefinitions.add(definitionHolder);<br>                <span class="hljs-comment">// 注册</span><br>                <span class="hljs-built_in">this</span>.registerBeanDefinition(definitionHolder, <span class="hljs-built_in">this</span>.registry);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> beanDefinitions;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="反射工具"><a href="#反射工具" class="headerlink" title="反射工具"></a>反射工具</h1><h2 id="BeanWrapper"><a href="#BeanWrapper" class="headerlink" title="BeanWrapper"></a>BeanWrapper</h2><ol>
<li>Spring 自己封装的反射工具类，通过调用 API 快捷的封装 BeanDefinition 中的参数属性。</li>
</ol>
<h1 id="XML-解析"><a href="#XML-解析" class="headerlink" title="XML 解析"></a>XML 解析</h1><ol>
<li>将 XML 读入到内存中（元数据）都是以字符串的形式展示的，Spring 中封装成了<code>TypedStringValue</code>，其中定义了<code>targetType</code>转换的目标类型。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypedStringValue</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanMetadataElement</span>, Comparable&lt;TypedStringValue&gt; &#123;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> String value;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Object targetType;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> Object source;<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> String specifiedTypeName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> dynamic;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="Converters"><a href="#Converters" class="headerlink" title="Converters"></a>Converters</h1><ol>
<li>Spring 提供内置的类型转换服务。</li>
<li>在其实现类中可以看出添加了很多 Spring 为我们写好的类型转换类，我们还可以通过自定义类型转换类，来实现自己的转换逻辑。</li>
</ol>
<p><img src="/mimi-blog/image/1728974018400-30f5eeeb-d7c0-4a39-9b49-f60d4e9a28d9.png" srcset="/mimi-blog/img/loading.gif" lazyload></p>
<h1 id="StandardEnviroment"><a href="#StandardEnviroment" class="headerlink" title="StandardEnviroment"></a>StandardEnviroment</h1><ol>
<li>Spring 标准环境，一些应用启动时的配置文件以及系统信息会被加载到 StandardEnviroment 中，供 Spring 运行时使用。</li>
<li>其中 profile 场景就可以在StandardEnviroment 中指定。</li>
</ol>
<h1 id="SPEL-表达式"><a href="#SPEL-表达式" class="headerlink" title="SPEL 表达式"></a>SPEL 表达式</h1><h1 id="容器和上下文"><a href="#容器和上下文" class="headerlink" title="容器和上下文"></a>容器和上下文</h1><p><img src="/mimi-blog/image/1728977669199-d7713f12-deb9-4984-8a16-22b2d7f7b6ee.png" srcset="/mimi-blog/img/loading.gif" lazyload></p>
<h2 id="ObjectPorvider"><a href="#ObjectPorvider" class="headerlink" title="ObjectPorvider"></a>ObjectPorvider</h2><ol>
<li>ObjectProvider 接口可以承接生成的 Bean，对 Bean 的获取做了一层隔离效果。</li>
<li>显示注入和隐式注入：<ol>
<li>显示注入：通过 Autowire 注解（setter、field）等。</li>
<li>隐式注入：通过<code>构造器注入</code>，Spring 在初始化类时会通过构造器参数自动注入到类的属性字段上去，默认初始化时调用无参构造。</li>
</ol>
</li>
<li>隐式注入可能出现的问题：当使用构造器注入时，容器中没有目标 Bean，如果不适用 ObjectProvider 包装则会直接报错<code>构造器的第 n 个参数在容器中未找到</code>。</li>
<li><code>public Test(ObjectProvider&lt;OrderService&gt; bean)&#123;&#125;</code>，这样即使容器中没有目标 Bean 也不会报错，可以通过 ObjectProvider 接口中提供的 api 获取目标 Bean<code>如果存在的话</code>。</li>
<li>ObjectProvider 还继承了Iterable 接口，说明具有迭代功能，可以从容器中拿到如同类型的 Bean 供我们选择注入。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ObjectProvider</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectFactory</span>&lt;T&gt;, Iterable&lt;T&gt; &#123;<br>    T <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object... var1)</span> <span class="hljs-keyword">throws</span> BeansException;<br><br>    <span class="hljs-meta">@Nullable</span><br>    T <span class="hljs-title function_">getIfAvailable</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException;<br><br>    <span class="hljs-keyword">default</span> T <span class="hljs-title function_">getIfAvailable</span><span class="hljs-params">(Supplier&lt;T&gt; defaultSupplier)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-type">T</span> <span class="hljs-variable">dependency</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getIfAvailable();<br>        <span class="hljs-keyword">return</span> dependency != <span class="hljs-literal">null</span> ? dependency : defaultSupplier.get();<br>    &#125;<br><br>    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ifAvailable</span><span class="hljs-params">(Consumer&lt;T&gt; dependencyConsumer)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-type">T</span> <span class="hljs-variable">dependency</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getIfAvailable();<br>        <span class="hljs-keyword">if</span> (dependency != <span class="hljs-literal">null</span>) &#123;<br>            dependencyConsumer.accept(dependency);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Nullable</span><br>    T <span class="hljs-title function_">getIfUnique</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException;<br><br>    <span class="hljs-keyword">default</span> T <span class="hljs-title function_">getIfUnique</span><span class="hljs-params">(Supplier&lt;T&gt; defaultSupplier)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-type">T</span> <span class="hljs-variable">dependency</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getIfUnique();<br>        <span class="hljs-keyword">return</span> dependency != <span class="hljs-literal">null</span> ? dependency : defaultSupplier.get();<br>    &#125;<br><br>    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ifUnique</span><span class="hljs-params">(Consumer&lt;T&gt; dependencyConsumer)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-type">T</span> <span class="hljs-variable">dependency</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getIfUnique();<br>        <span class="hljs-keyword">if</span> (dependency != <span class="hljs-literal">null</span>) &#123;<br>            dependencyConsumer.accept(dependency);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">default</span> Iterator&lt;T&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.stream().iterator();<br>    &#125;<br><br>    <span class="hljs-keyword">default</span> Stream&lt;T&gt; <span class="hljs-title function_">stream</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Multi element access not supported&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">default</span> Stream&lt;T&gt; <span class="hljs-title function_">orderedStream</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Ordered element access not supported&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ObjectFacotry"><a href="#ObjectFacotry" class="headerlink" title="ObjectFacotry"></a>ObjectFacotry</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ObjectFactory</span>&lt;T&gt; &#123;<br>    T <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li>在 Spring 中可以见到大量的 ObjectFactory，在<code>AbstractAutowireCapableBeanFactory</code>类中就有体现，通过 InstantiationStrategy（实例化策略，默认 CGLIB）对目标 Bean 进行实例化。</li>
<li>可以通过自己的方式对一个目标 Bean 进行复杂的处理等，对 Bean 包装成代理对象。</li>
</ol>
<h2 id="FactoryBean"><a href="#FactoryBean" class="headerlink" title="FactoryBean"></a>FactoryBean</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FactoryBean</span>&lt;T&gt; &#123;<br>    <span class="hljs-meta">@Nullable</span><br>    T <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br><br>    <span class="hljs-meta">@Nullable</span><br>    Class&lt;?&gt; getObjectType();<br><br>    <span class="hljs-keyword">default</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSingleton</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li>可以通过实现 FactoryBean 接口，对复杂的 Bean 进行初始化，例如 Mybatis 中的 SqlSessionFactory 就是实现了 FactoryBean 接口对 SqlSession 进行了复杂的封装。</li>
</ol>
<h2 id="扩展点"><a href="#扩展点" class="headerlink" title="扩展点"></a>扩展点</h2><ol>
<li>Spring 中的每个功能环节中都给我们预留了扩展点，例如在 Bean 初始化前后需要做哪些事情（留给用户自己实现-可实现）等。</li>
<li>常用到的 Bean 初始化前后置处理，例如BeanFactoryPostProcessor，这是一个接口，我们只需要实现这个接口中的方法，将功能点写入即可（注册到 IOC 容器中）。</li>
</ol>
<p>:::color3<br>@PostConstract 初始化方法是在 beforePostProcessor 和 afterPostProcessor 之间执行的。</p>
<p>执行顺序：beforePostProcessor → PostConstract → afterPostProcessor</p>
<p>:::</p>
<h2 id="上下文-ApplicationContext"><a href="#上下文-ApplicationContext" class="headerlink" title="上下文 ApplicationContext"></a>上下文 ApplicationContext</h2><ol>
<li>refresh 模板设计模式，各种场景下加载时的 refresh。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException &#123;<br>    <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>.startupShutdownMonitor) &#123;<br>        <span class="hljs-built_in">this</span>.prepareRefresh();<br>        <span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.obtainFreshBeanFactory();<br>        <span class="hljs-built_in">this</span>.prepareBeanFactory(beanFactory);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.postProcessBeanFactory(beanFactory);<br>            <span class="hljs-built_in">this</span>.invokeBeanFactoryPostProcessors(beanFactory);<br>            <span class="hljs-built_in">this</span>.registerBeanPostProcessors(beanFactory);<br>            <span class="hljs-built_in">this</span>.initMessageSource();<br>            <span class="hljs-built_in">this</span>.initApplicationEventMulticaster();<br>            <span class="hljs-built_in">this</span>.onRefresh();<br>            <span class="hljs-built_in">this</span>.registerListeners();<br>            <span class="hljs-built_in">this</span>.finishBeanFactoryInitialization(beanFactory);<br>            <span class="hljs-built_in">this</span>.finishRefresh();<br>        &#125; <span class="hljs-keyword">catch</span> (BeansException var9) &#123;<br>            <span class="hljs-type">BeansException</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> var9;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isWarnEnabled()) &#123;<br>                <span class="hljs-built_in">this</span>.logger.warn(<span class="hljs-string">&quot;Exception encountered during context initialization - cancelling refresh attempt: &quot;</span> + ex);<br>            &#125;<br><br>            <span class="hljs-built_in">this</span>.destroyBeans();<br>            <span class="hljs-built_in">this</span>.cancelRefresh(ex);<br>            <span class="hljs-keyword">throw</span> ex;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-built_in">this</span>.resetCommonCaches();<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="准备刷新"><a href="#准备刷新" class="headerlink" title="准备刷新"></a>准备刷新</h3><ol>
<li>对 Environment 的创建，在 AbstractApplicationContext 中有一个 ConfigurableEnvironment 类型的成员变量，在第一次调用<code>getEnvironment</code>时会<code>new StandardEnvironment()</code>。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> ConfigurableEnvironment <span class="hljs-title function_">createEnvironment</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEnvironment</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>当我们需要创建一个 WEB 环境时，在 GenericWebApplicationContext 中对其 WEB 环境进行了初始化。注册了两个 Servlet 属性源<code>servletContextInitParams</code>和<code>servletConfigInitParams</code>。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initPropertySources</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ServletContext servletContext, <span class="hljs-meta">@Nullable</span> ServletConfig servletConfig)</span> &#123;<br>    WebApplicationContextUtils<br>    .initServletPropertySources(<span class="hljs-built_in">this</span>.getPropertySources()<br>                                , servletContext<br>                                , servletConfig);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initServletPropertySources</span><span class="hljs-params">(MutablePropertySources sources, <span class="hljs-meta">@Nullable</span> ServletContext servletContext, <span class="hljs-meta">@Nullable</span> ServletConfig servletConfig)</span> &#123;<br>    Assert.notNull(sources, <span class="hljs-string">&quot;&#x27;propertySources&#x27; must not be null&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;servletContextInitParams&quot;</span>;<br>    <span class="hljs-keyword">if</span> (servletContext != <span class="hljs-literal">null</span> &amp;&amp; sources.contains(name) &amp;&amp; sources.get(name) <span class="hljs-keyword">instanceof</span> PropertySource.StubPropertySource) &#123;<br>        sources.replace(name, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletContextPropertySource</span>(name, servletContext));<br>    &#125;<br><br>    name = <span class="hljs-string">&quot;servletConfigInitParams&quot;</span>;<br>    <span class="hljs-keyword">if</span> (servletConfig != <span class="hljs-literal">null</span> &amp;&amp; sources.contains(name) &amp;&amp; sources.get(name) <span class="hljs-keyword">instanceof</span> PropertySource.StubPropertySource) &#123;<br>        sources.replace(name, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletConfigPropertySource</span>(name, servletConfig));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>对 Spring 中的<code>earlyApplicationListeners</code>进行<code>clear</code>操作，有的容器可以做刷新有的容器不可以做刷新。</li>
</ol>
<h3 id="准备-BeanFactory"><a href="#准备-BeanFactory" class="headerlink" title="准备 BeanFactory"></a>准备 BeanFactory</h3><ol>
<li>在 <code>AbstractApplicationContext</code>中<code>&lt;font style=&quot;color:#000000;&quot;&gt;prepareBeanFactory&lt;/font&gt;</code><font style="color:#000000;">中对 Spring 运行时所需要的 Bean 做注册。</font></li>
</ol>
<p><img src="/mimi-blog/image/1729171572346-9ebb74ce-fc66-4f48-bcaf-83413aabd00d.png" srcset="/mimi-blog/img/loading.gif" lazyload></p>
<h3 id="postProcessBeanFactory"><a href="#postProcessBeanFactory" class="headerlink" title="postProcessBeanFactory"></a>postProcessBeanFactory</h3><ol>
<li>留给子类去实现，例如 SpringMVC 会实现<code>postProcessBeanFactory</code>功能来实现在 BeanFactory 初始化前后做额外处理。</li>
<li>在 Web 环境下中给我们额外注册了三个 Bean 作用域，分别是<code>Application</code>、<code>Session</code>和<code>Request</code>三个。</li>
</ol>
<p>:::color3<br>Spring 中 Bean 的作用域分别是哪些？</p>
<ol>
<li>非 Web 环境下，singleton 和 prototype。</li>
<li>在 Web 环境下，singleton、prototype、application、session、request</li>
</ol>
<p>:::</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerWebApplicationScopes</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory, <span class="hljs-meta">@Nullable</span> ServletContext sc)</span> &#123;<br>    beanFactory.registerScope(<span class="hljs-string">&quot;request&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestScope</span>());<br>    beanFactory.registerScope(<span class="hljs-string">&quot;session&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SessionScope</span>());<br>    <span class="hljs-keyword">if</span> (sc != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">ServletContextScope</span> <span class="hljs-variable">appScope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletContextScope</span>(sc);<br>        beanFactory.registerScope(<span class="hljs-string">&quot;application&quot;</span>, appScope);<br>        sc.setAttribute(ServletContextScope.class.getName(), appScope);<br>    &#125;<br><br>    beanFactory.registerResolvableDependency(ServletRequest.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestObjectFactory</span>());<br>    beanFactory.registerResolvableDependency(ServletResponse.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseObjectFactory</span>());<br>    beanFactory.registerResolvableDependency(HttpSession.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SessionObjectFactory</span>());<br>    beanFactory.registerResolvableDependency(WebRequest.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebRequestObjectFactory</span>());<br>    <span class="hljs-keyword">if</span> (jsfPresent) &#123;<br>        WebApplicationContextUtils.FacesDependencyRegistrar.registerFacesDependencies(beanFactory);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="registerBeanPostProcessors"><a href="#registerBeanPostProcessors" class="headerlink" title="registerBeanPostProcessors"></a>registerBeanPostProcessors</h3><ol>
<li>对于注册的 Bean 的后置处理，其中源码体现（实现 PriorityOrdered 接口或者 Ordered 接口）的 Bean 的后置处理器按照其设置的顺序进行填充。触发时按照 Ordered 顺序进行执行。</li>
</ol>
<h3 id="initMessageSource"><a href="#initMessageSource" class="headerlink" title="initMessageSource"></a>initMessageSource</h3><ol>
<li>处理消息源（i18n）。</li>
</ol>
<h3 id="initApplicationEventMulticaster"><a href="#initApplicationEventMulticaster" class="headerlink" title="initApplicationEventMulticaster"></a>initApplicationEventMulticaster</h3><ol>
<li>初始化应用多播器。</li>
</ol>
<h3 id="onRefresh"><a href="#onRefresh" class="headerlink" title="onRefresh"></a>onRefresh</h3><ol>
<li>上下文刷新操作，针对于不同的子类有着不同的实现。</li>
<li>AbstractRefreshableWebApplicationContext：切换主题源（theme）。</li>
<li>GenericWebApplicationContext：对 WebServer 进行创建，<code>createWebServer</code>讲 web 所需要的上下文对象 <code>servletContext</code>注册到上下文环境中。</li>
</ol>
<p><img src="/mimi-blog/image/1729301274943-09d72d7a-402f-4865-b919-cfc322845080.png" srcset="/mimi-blog/img/loading.gif" lazyload></p>
<h3 id="registerListeners"><a href="#registerListeners" class="headerlink" title="registerListeners"></a>registerListeners</h3><ol>
<li>注册监听器，当容器创建完成后的监听操作，我们可以通过实现接口来完成容器初始化后的一些操作。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationListener</span>&lt;ContextRefreshedEvent&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(ContextRefreshedEvent event)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;MyListner onApplicationEvent&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="finishBeanFactoryInitialization"><a href="#finishBeanFactoryInitialization" class="headerlink" title="finishBeanFactoryInitialization"></a>finishBeanFactoryInitialization</h3><ol>
<li>对各种类型的 Bean 进行初始化操作。</li>
<li>在<code>finishBeanFactoryInitialization</code>的前置功能是为 Bean 的创建做一些铺垫。</li>
<li><code>freezeConfiguration</code>冻结配置，包含<code>clearMetadataCache</code>、<code>configurationFrozen</code>、<code>frozenBeanDefinitionNames</code>操作，对缓存的元数据做清除并对是否冻结配置标志做修改。</li>
</ol>
<p>:::color3<br><code>preInstantiateSingletons</code>方法中说明了对单例 Bean、多例 Bean 以及 ObjectFactory 的区别初始化操作。</p>
<p>:::</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finishBeanFactoryInitialization</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;<br>    <span class="hljs-keyword">if</span> (beanFactory.containsBean(<span class="hljs-string">&quot;conversionService&quot;</span>) &amp;&amp; beanFactory.isTypeMatch(<span class="hljs-string">&quot;conversionService&quot;</span>, ConversionService.class)) &#123;<br>        beanFactory.setConversionService((ConversionService)beanFactory.getBean(<span class="hljs-string">&quot;conversionService&quot;</span>, ConversionService.class));<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;<br>        beanFactory.addEmbeddedValueResolver((strVal) -&gt; &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getEnvironment().resolvePlaceholders(strVal);<br>        &#125;);<br>    &#125;<br>    <br>    String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>    String[] var3 = weaverAwareNames;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> weaverAwareNames.length;<br>    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var5 &lt; var4; ++var5) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">weaverAwareName</span> <span class="hljs-operator">=</span> var3[var5];<br>        beanFactory.getBean(weaverAwareName, LoadTimeWeaverAware.class);<br>    &#125;<br>    <br>    beanFactory.setTempClassLoader((ClassLoader)<span class="hljs-literal">null</span>);<br>    beanFactory.freezeConfiguration();<br>    beanFactory.preInstantiateSingletons();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>:::color4</p>
<ol>
<li>先将其转化为<code>RootBeanDefinition</code>，用于管理不同的 <code>BeanDefinition</code>。</li>
<li>查看 Bean 是否是 ObjectFactory，这里ObjectFactory 注册时和普通的 Bean 是不一样的（添加一个’&amp;’前缀）。</li>
<li>Object bean &#x3D; this.getBean(“&amp;” + beanName); ， 这一代码中体现了对 ObjectFactory 的 getObject 的调用。</li>
</ol>
<p>:::</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preInstantiateSingletons</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException &#123; <br>    List&lt;String&gt; beanNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(<span class="hljs-built_in">this</span>.beanDefinitionNames);<br>    <span class="hljs-type">Iterator</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> beanNames.iterator();<br>    String beanName;<br>    <span class="hljs-keyword">while</span>(var2.hasNext()) &#123;<br>        beanName = (String)var2.next();<br>        <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getMergedLocalBeanDefinition(beanName);<br>        <span class="hljs-keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isFactoryBean(beanName)) &#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getBean(<span class="hljs-string">&quot;&amp;&quot;</span> + beanName);<br>                <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> SmartFactoryBean) &#123;<br>                    SmartFactoryBean&lt;?&gt; smartFactoryBean = (SmartFactoryBean)bean;<br>                    <span class="hljs-keyword">if</span> (smartFactoryBean.isEagerInit()) &#123;<br>                        <span class="hljs-built_in">this</span>.getBean(beanName);<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-built_in">this</span>.getBean(beanName);<br>            &#125;<br>        &#125;<br>    &#125;<br>    var2 = beanNames.iterator();<br>    <span class="hljs-keyword">while</span>(var2.hasNext()) &#123;<br>        beanName = (String)var2.next();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">singletonInstance</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getSingleton(beanName);<br>        <span class="hljs-keyword">if</span> (singletonInstance <span class="hljs-keyword">instanceof</span> SmartInitializingSingleton smartSingleton) &#123;<br>            <span class="hljs-type">StartupStep</span> <span class="hljs-variable">smartInitialize</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getApplicationStartup().start(<span class="hljs-string">&quot;spring.beans.smart-initialize&quot;</span>).tag(<span class="hljs-string">&quot;beanName&quot;</span>, beanName);<br>            smartSingleton.afterSingletonsInstantiated();<br>            smartInitialize.end();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>:::color4<br>doGetBean 中实现了在何种 scope 下应该做那么操作等。</p>
<ol>
<li>look-up：Bean 配置了 look-up 参数。</li>
<li>requiredType</li>
<li>depends-on：Bean 配置了depends-on，表示当前 Bean 初始化前需要对其依赖的 Bean 做初始化。</li>
<li>scope-&gt;singleton：createBean</li>
<li>scope-&gt;prototype：createBean</li>
<li>scope-&gt;其他</li>
<li>对于不同的 scope，其对应的 createBean 的效果是不一样的。</li>
</ol>
<p>:::</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">doGetBean</span><span class="hljs-params">(String name, <span class="hljs-meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="hljs-meta">@Nullable</span> Object[] args, <span class="hljs-type">boolean</span> typeCheckOnly)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformedBeanName(name);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">sharedInstance</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getSingleton(beanName);<br>    Object beanInstance;<br>    <span class="hljs-keyword">if</span> (sharedInstance != <span class="hljs-literal">null</span> &amp;&amp; args == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isTraceEnabled()) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isSingletonCurrentlyInCreation(beanName)) &#123;<br>                <span class="hljs-built_in">this</span>.logger.trace(<span class="hljs-string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-built_in">this</span>.logger.trace(<span class="hljs-string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>            &#125;<br>        &#125;<br><br>        beanInstance = <span class="hljs-built_in">this</span>.getObjectForBeanInstance(sharedInstance, name, beanName, (RootBeanDefinition)<span class="hljs-literal">null</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isPrototypeCurrentlyInCreation(beanName)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName);<br>        &#125;<br><br>        <span class="hljs-type">BeanFactory</span> <span class="hljs-variable">parentBeanFactory</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getParentBeanFactory();<br>        <span class="hljs-keyword">if</span> (parentBeanFactory != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-built_in">this</span>.containsBeanDefinition(beanName)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">nameToLookup</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.originalBeanName(name);<br>            <span class="hljs-keyword">if</span> (parentBeanFactory <span class="hljs-keyword">instanceof</span> AbstractBeanFactory) &#123;<br>                <span class="hljs-type">AbstractBeanFactory</span> <span class="hljs-variable">abf</span> <span class="hljs-operator">=</span> (AbstractBeanFactory)parentBeanFactory;<br>                <span class="hljs-keyword">return</span> abf.doGetBean(nameToLookup, requiredType, args, typeCheckOnly);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup, args);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!typeCheckOnly) &#123;<br>            <span class="hljs-built_in">this</span>.markBeanAsCreated(beanName);<br>        &#125;<br><br>        <span class="hljs-type">StartupStep</span> <span class="hljs-variable">beanCreation</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.beans.instantiate&quot;</span>).tag(<span class="hljs-string">&quot;beanName&quot;</span>, name);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span>) &#123;<br>                Objects.requireNonNull(requiredType);<br>                beanCreation.tag(<span class="hljs-string">&quot;beanType&quot;</span>, requiredType::toString);<br>            &#125;<br><br>            <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbd</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getMergedLocalBeanDefinition(beanName);<br>            <span class="hljs-built_in">this</span>.checkMergedBeanDefinition(mbd, beanName, args);<br>            String[] dependsOn = mbd.getDependsOn();<br>            String[] prototypeInstance;<br>            <span class="hljs-keyword">if</span> (dependsOn != <span class="hljs-literal">null</span>) &#123;<br>                prototypeInstance = dependsOn;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">var13</span> <span class="hljs-operator">=</span> dependsOn.length;<br><br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var14</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var14 &lt; var13; ++var14) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">dep</span> <span class="hljs-operator">=</span> prototypeInstance[var14];<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isDependent(beanName, dep)) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                    &#125;<br><br>                    <span class="hljs-built_in">this</span>.registerDependentBean(dep, beanName);<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-built_in">this</span>.getBean(dep);<br>                    &#125; <span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException var33) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;&#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>, var33);<br>                    &#125; <span class="hljs-keyword">catch</span> (BeanCreationException var34) &#123;<br>                        <span class="hljs-type">BeanCreationException</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> var34;<br>                        <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-type">String</span> <span class="hljs-variable">var10002</span> <span class="hljs-operator">=</span> mbd.getResourceDescription();<br>                            <span class="hljs-type">String</span> <span class="hljs-variable">var10004</span> <span class="hljs-operator">=</span> ex.getBeanName();<br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(var10002, beanName, <span class="hljs-string">&quot;Failed to initialize dependency &#x27;&quot;</span> + var10004 + <span class="hljs-string">&quot;&#x27; of &quot;</span> + requiredType.getSimpleName() + <span class="hljs-string">&quot; bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;: &quot;</span> + ex.getMessage(), ex);<br>                        &#125;<br><br>                        <span class="hljs-keyword">throw</span> ex;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>                sharedInstance = <span class="hljs-built_in">this</span>.getSingleton(beanName, () -&gt; &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.createBean(beanName, mbd, args);<br>                    &#125; <span class="hljs-keyword">catch</span> (BeansException var5) &#123;<br>                        <span class="hljs-type">BeansException</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> var5;<br>                        <span class="hljs-built_in">this</span>.destroySingleton(beanName);<br>                        <span class="hljs-keyword">throw</span> ex;<br>                    &#125;<br>                &#125;);<br>                beanInstance = <span class="hljs-built_in">this</span>.getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mbd.isPrototype()) &#123;<br>                prototypeInstance = <span class="hljs-literal">null</span>;<br><br>                Object prototypeInstance;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-built_in">this</span>.beforePrototypeCreation(beanName);<br>                    prototypeInstance = <span class="hljs-built_in">this</span>.createBean(beanName, mbd, args);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    <span class="hljs-built_in">this</span>.afterPrototypeCreation(beanName);<br>                &#125;<br><br>                beanInstance = <span class="hljs-built_in">this</span>.getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">scopeName</span> <span class="hljs-operator">=</span> mbd.getScope();<br>                <span class="hljs-keyword">if</span> (!StringUtils.hasLength(scopeName)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No scope name defined for bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                &#125;<br><br>                <span class="hljs-type">Scope</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> (Scope)<span class="hljs-built_in">this</span>.scopes.get(scopeName);<br>                <span class="hljs-keyword">if</span> (scope == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                &#125;<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">scopedInstance</span> <span class="hljs-operator">=</span> scope.get(beanName, () -&gt; &#123;<br>                        <span class="hljs-built_in">this</span>.beforePrototypeCreation(beanName);<br><br>                        Object var4;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            var4 = <span class="hljs-built_in">this</span>.createBean(beanName, mbd, args);<br>                        &#125; <span class="hljs-keyword">finally</span> &#123;<br>                            <span class="hljs-built_in">this</span>.afterPrototypeCreation(beanName);<br>                        &#125;<br><br>                        <span class="hljs-keyword">return</span> var4;<br>                    &#125;);<br>                    beanInstance = <span class="hljs-built_in">this</span>.getObjectForBeanInstance(scopedInstance, name, beanName, mbd);<br>                &#125; <span class="hljs-keyword">catch</span> (IllegalStateException var32) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScopeNotActiveException</span>(beanName, scopeName, var32);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (BeansException var35) &#123;<br>            <span class="hljs-type">BeansException</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> var35;<br>            beanCreation.tag(<span class="hljs-string">&quot;exception&quot;</span>, ex.getClass().toString());<br>            beanCreation.tag(<span class="hljs-string">&quot;message&quot;</span>, String.valueOf(ex.getMessage()));<br>            <span class="hljs-built_in">this</span>.cleanupAfterBeanCreationFailure(beanName);<br>            <span class="hljs-keyword">throw</span> ex;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            beanCreation.end();<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.isCacheBeanMetadata()) &#123;<br>                <span class="hljs-built_in">this</span>.clearMergedBeanDefinition(beanName);<br>            &#125;<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.adaptBeanInstance(name, beanInstance, requiredType);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="循环依赖"><a href="#循环依赖" class="headerlink" title="循环依赖"></a>循环依赖</h2><ol>
<li>以下代码就具备了循环依赖的条件，我们不适用 Spring 的自动注入功能，我们也没有办法处理这种循环依赖的问题（构造器注入）。</li>
<li>使用 set 字段注入时在编码层面上就可以解决这样的问题。</li>
<li>在 Spring3.x 版本中循环依赖会出现<code>UnsatisfiedDependencyException</code>错误。</li>
<li>我们试图将其改为 set 注入，并且在 application.yaml&#x2F;.properties 中对<code>spring.main.allow-circular-references=true </code>做修改后，就不会出现循环依赖的错误。</li>
</ol>
<p>:::color4<br>三级缓存：singletonObjects、earlySingletonObjects、singletonFactories</p>
<p>:::</p>
<p><img src="/mimi-blog/image/1729318401537-1b939e0f-10b8-4bd9-91ee-cae9a28010cf.png" srcset="/mimi-blog/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>&#123;<br>    <span class="hljs-keyword">private</span> B b;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">A</span><span class="hljs-params">(B b)</span> &#123;<br>        <span class="hljs-built_in">this</span>.b = b;<br>    &#125;<br>&#125;<br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span>&#123;<br>    <span class="hljs-keyword">private</span> A a;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">B</span><span class="hljs-params">(A a)</span> &#123;<br>        <span class="hljs-built_in">this</span>.a = a;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>:::color4</p>
<ol>
<li>doCreateBean 中对循环依赖问题做了对应的处理。</li>
<li>BeanWrapper 将对应 Bean 先包装成一个方便反射的类。</li>
<li>earlySingletonExposure 参数表示是否需要<code>提前暴露一个单例 Bean</code>。<ol>
<li>this.addSingletonFactory，将其包装为一个 ObjectBean 放入 SingletonFactory 中。</li>
</ol>
</li>
<li>populateBean 填充 Bean，对 Bean 的属性做填充。</li>
</ol>
<p>:::</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span> <span class="hljs-keyword">throws</span> BeanCreationException &#123;<br>    <span class="hljs-type">BeanWrapper</span> <span class="hljs-variable">instanceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>        instanceWrapper = (BeanWrapper)<span class="hljs-built_in">this</span>.factoryBeanInstanceCache.remove(beanName);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-literal">null</span>) &#123;<br>        instanceWrapper = <span class="hljs-built_in">this</span>.createBeanInstance(beanName, mbd, args);<br>    &#125;<br><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> instanceWrapper.getWrappedInstance();<br>    Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();<br>    <span class="hljs-keyword">if</span> (beanType != NullBean.class) &#123;<br>        mbd.resolvedTargetType = beanType;<br>    &#125;<br><br>    <span class="hljs-keyword">synchronized</span>(mbd.postProcessingLock) &#123;<br>        <span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-built_in">this</span>.applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable var17) &#123;<br>                <span class="hljs-type">Throwable</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> var17;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);<br>            &#125;<br><br>            mbd.markAsPostProcessed();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">earlySingletonExposure</span> <span class="hljs-operator">=</span> mbd.isSingleton() &amp;&amp; <span class="hljs-built_in">this</span>.allowCircularReferences <br>                                            &amp;&amp; <span class="hljs-built_in">this</span>.isSingletonCurrentlyInCreation(beanName);<br>    <span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isTraceEnabled()) &#123;<br>            <span class="hljs-built_in">this</span>.logger.trace(<span class="hljs-string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.addSingletonFactory(beanName, () -&gt; &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getEarlyBeanReference(beanName, mbd, bean);<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">exposedObject</span> <span class="hljs-operator">=</span> bean;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">this</span>.populateBean(beanName, mbd, instanceWrapper);<br>        exposedObject = <span class="hljs-built_in">this</span>.initializeBean(beanName, exposedObject, mbd);<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable var18) &#123;<br>        <span class="hljs-type">Throwable</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> var18;<br>        <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> BeanCreationException bce) &#123;<br>            <span class="hljs-keyword">if</span> (beanName.equals(bce.getBeanName())) &#123;<br>                <span class="hljs-keyword">throw</span> bce;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName, ex.getMessage(), ex);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">earlySingletonReference</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getSingleton(beanName, <span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">if</span> (earlySingletonReference != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (exposedObject == bean) &#123;<br>                exposedObject = earlySingletonReference;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; <span class="hljs-built_in">this</span>.hasDependentBean(beanName)) &#123;<br>                String[] dependentBeans = <span class="hljs-built_in">this</span>.getDependentBeans(beanName);<br>                Set&lt;String&gt; actualDependentBeans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>(dependentBeans.length);<br>                String[] var12 = dependentBeans;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">var13</span> <span class="hljs-operator">=</span> dependentBeans.length;<br><br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var14</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var14 &lt; var13; ++var14) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">dependentBean</span> <span class="hljs-operator">=</span> var12[var14];<br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;<br>                        actualDependentBeans.add(dependentBean);<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName, <span class="hljs-string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; has been injected into other beans [&quot;</span> + StringUtils.collectionToCommaDelimitedString(actualDependentBeans) + <span class="hljs-string">&quot;] in its raw version as part of a circular reference, but has eventually been wrapped. This means that said other beans do not use the final version of the bean. This is often the result of over-eager type matching - consider using &#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">this</span>.registerDisposableBeanIfNecessary(beanName, bean, mbd);<br>        <span class="hljs-keyword">return</span> exposedObject;<br>    &#125; <span class="hljs-keyword">catch</span> (BeanDefinitionValidationException var16) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Invalid destruction signature&quot;</span>, var16);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/mimi-blog/image/1729317823228-1799276b-3fad-43b9-ba29-816c236e13b0.png" srcset="/mimi-blog/img/loading.gif" lazyload></p>
<p>:::color4</p>
<ol>
<li>从一级缓存中获取 bean。</li>
<li>从二级缓存中获取 bean。</li>
<li>双检加锁解决多线程下带来的单例问题。</li>
<li>从三级缓存中获取 bean。</li>
<li>将三级缓存中的 bean 放入二级缓存中（早期暴露）。</li>
<li>删除三级缓存中的 bean。</li>
</ol>
<p>:::</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getSingleton</span><span class="hljs-params">(String beanName, <span class="hljs-type">boolean</span> allowEarlyReference)</span> &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">singletonObject</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);<br>    <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.isSingletonCurrentlyInCreation(beanName)) &#123;<br>        singletonObject = <span class="hljs-built_in">this</span>.earlySingletonObjects.get(beanName);<br>        <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; allowEarlyReference) &#123;<br>            <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>.singletonObjects) &#123;<br>                singletonObject = <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);<br>                <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;<br>                    singletonObject = <span class="hljs-built_in">this</span>.earlySingletonObjects.get(beanName);<br>                    <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;<br>                        ObjectFactory&lt;?&gt; singletonFactory = (ObjectFactory)<span class="hljs-built_in">this</span>.singletonFactories.get(beanName);<br>                        <span class="hljs-keyword">if</span> (singletonFactory != <span class="hljs-literal">null</span>) &#123;<br>                            singletonObject = singletonFactory.getObject();<br>                            <span class="hljs-built_in">this</span>.earlySingletonObjects.put(beanName, singletonObject);<br>                            <span class="hljs-built_in">this</span>.singletonFactories.remove(beanName);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h1 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h1><h2 id="探针"><a href="#探针" class="headerlink" title="探针"></a>探针</h2><ol>
<li>aspactj 探针技术，在 JVM 加载时通过指定 agent 将需要植入的代码植入到源 class 字节码中。</li>
<li>分为编译器织入、运行期织入等，只要能找到切入点就可以进行织入操作（private、final）都是可以的。</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">Manifest-Version</span>: <span class="hljs-string">1.0</span><br><br><span class="hljs-attr">Name</span>: <span class="hljs-string">org/aspectj/lib/</span><br><span class="hljs-attr">Specification-Title</span>: <span class="hljs-string">AspectJ Library Classes </span><br><span class="hljs-attr">Specification-Version</span>: <span class="hljs-string">1.6</span><br><span class="hljs-attr">Specification-Vendor</span>: <span class="hljs-string">aspectj.org</span><br><span class="hljs-attr">Implementation-Title</span>: <span class="hljs-string">org.aspectj.lib</span><br><span class="hljs-attr">Implementation-Version</span>: <span class="hljs-string">1.6.2</span><br><span class="hljs-attr">Implementation-Vendor</span>: <span class="hljs-string">aspectj.org</span><br><span class="hljs-attr">Bundle-Name</span>: <span class="hljs-string">AspectJ</span><br><span class="hljs-attr">Bundle-Version</span>: <span class="hljs-string">1.6</span><br><span class="hljs-attr">Import-Package</span>: <span class="hljs-string">org.aspectj.lib,org.aspectj.lib.pointcuts</span><br><span class="hljs-attr">Bundle-Copyright</span>: <span class="hljs-string">(C) Copyright 2005 Contributors. </span><br>  <span class="hljs-attr">All</span> <span class="hljs-string">Rights Reserved.</span><br></code></pre></td></tr></table></figure>

<h2 id="Spring-开启-LTW（LoadTimedWearer）"><a href="#Spring-开启-LTW（LoadTimedWearer）" class="headerlink" title="Spring 开启 LTW（LoadTimedWearer）"></a>Spring 开启 LTW（LoadTimedWearer）</h2><ol>
<li>需要在 &#x2F;MATE-INF&#x2F;aop.xml，中进行切面和切入点的配置。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableLoadTimeWeaving(aspectjWeaving = AspectJWeaving.ENABLED)</span><br></code></pre></td></tr></table></figure>

<h2 id="常规织入"><a href="#常规织入" class="headerlink" title="常规织入"></a>常规织入</h2><ol>
<li>EnableAspactJAutoProxy 注解可以帮我们注册一个<code>AspectJAutoProxyRegistrar</code>。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(&#123;AspectJAutoProxyRegistrar.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableAspectJAutoProxy &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">proxyTargetClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">exposeProxy</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/mimi-blog/tags/Java/" class="print-no-link">#Java</a>
      
        <a href="/mimi-blog/tags/%E7%9F%A5%E8%AF%86%E5%BA%93/" class="print-no-link">#知识库</a>
      
        <a href="/mimi-blog/tags/Spring/" class="print-no-link">#Spring</a>
      
        <a href="/mimi-blog/tags/%E6%BA%90%E7%A0%81/" class="print-no-link">#源码</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Spring源码</div>
      <div>https://xiaomaoboss.github.io/mimi-blog/2024/10/19/Spring源码/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Mimiboss</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年10月19日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2024年10月20日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/mimi-blog/2024/10/19/61-%E6%97%8B%E8%BD%AC%E9%93%BE%E8%A1%A8/" title="61-旋转链表">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">61-旋转链表</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/mimi-blog/2024/10/17/59-%E8%9E%BA%E6%97%8B%E7%9F%A9%E9%98%B5%E2%85%A1/" title="59.螺旋矩阵2">
                        <span class="hidden-mobile">59.螺旋矩阵2</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"rF1TKwTR5zRczZnrUWnkYBFR-gzGzoHsz","appKey":"kzqWcZjH2hNXEi4C1Qk2KO9Q","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  



  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/mimi-blog/js/events.js" ></script>
<script  src="/mimi-blog/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/mimi-blog/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/mimi-blog/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/mimi-blog/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
